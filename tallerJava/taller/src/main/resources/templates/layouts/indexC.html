<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es" th:fragment="layout(content)">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Tailwind (compilado localmente) -->
    <link rel="stylesheet" th:href="@{/css/tailwind-output.css}" href="/css/tailwind-output.css" />
    <style>
        .modal-overlay { backdrop-filter: blur(4px); }
        .animate-fade-in { animation: fadeIn 0.18s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        /* Notification visual styles use Tailwind utility classes in markup */
        .notif-arrow { width: 14px; height: 14px; position: absolute; transform: rotate(45deg); background: white; box-shadow: 0 2px 6px rgba(0,0,0,0.08); border-left: 1px solid rgba(0,0,0,0.06); border-top: 1px solid rgba(0,0,0,0.04); }
        .tab-active{ background: rgba(16,185,129,0.08); color:#065f46; }
        .tab-content .empty { padding: 1rem; color: #6b7280; text-align:center; }
          /* Nota: la visibilidad del navbar y del botón de toggle la controla JS/CSS.
              Se removió la regla que ocultaba globalmente `nav.navbar` y `#toggleMenuBtn`
              para permitir que `sidebar.js` active el sidebar en escritorio. */
    </style>
    <!-- Evitar destello de elementos decorativos grandes (p. ej. lupa) -->
    <style>
        .big-magnifier,
        .decorative-magnifier,
        .magnifier-overlay,
        .page-magnifier,
        svg.decorative,
        img.decorative,
        body > svg,
        .main-content-wrapper > svg {
            display: none !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" th:href="@{/css/estilosC.css}" href="/css/estilosC.css" />
    <script th:src="@{/js/exportar-novedades.js}" defer></script>
    <title>Coordinador</title>
</head>

<body>
<!-- Script mínimo: eliminar inmediatamente elementos decorativos grandes para evitar destellos al recargar -->
<script>
    (function(){
        try {
            const selectors = 'svg.decorative, .big-magnifier, .decorative-magnifier, .page-magnifier, .magnifier-overlay, img.decorative, body > svg, .main-content-wrapper > svg';
            // eliminar cualquier coincidencia ya presente antes de que termine el parseo
            document.querySelectorAll && document.querySelectorAll(selectors).forEach(el => el.remove());
        } catch(e) { /* no romper nada si falla */ }
    })();
</script>
<!-- Botón de menú hamburguesa -->
<button id="toggleMenuBtn" class="menu-toggle" aria-label="Abrir menú de navegación" aria-expanded="false">
    ☰
</button>

<nav class="navbar">
    <div class="menu-wrapper">
        <header></header>
    </div>

    <div class="user-info">
        <div class="header-right">
            <!-- Notificaciones: campana (Tailwind) -->
            <div id="notifWidget" class="relative inline-block mr-2"> <!-- posicion relativa para modal absoluto -->
                <div id="bell" class="relative w-9 h-9 flex items-center justify-center rounded-full hover:bg-emerald-50" title="Notificaciones" aria-haspopup="true" aria-expanded="false" role="button" style="min-width:36px;min-height:36px;">
                    <svg class="text-emerald-700" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h11z"></path>
                        <path d="M13.73 21a2 2 0 01-3.46 0"></path>
                    </svg>
                    <div id="notifCount" class="hidden absolute -top-1 -right-1 bg-red-600 text-white text-xs px-2 rounded-full">0</div>
                </div>
            </div>
            <div class="user-menu" id="userMenuBtn" role="button" aria-haspopup="true" aria-expanded="false">
                <img src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png" alt="Foto de perfil del usuario" class="user-photo" />
                <span class="user-name" th:text="${usuarioCoordinador != null ? (usuarioCoordinador.nombre + ' ' + usuarioCoordinador.apellido) : 'Coordinador'}">JC</span>
            </div>
            <!-- Botón visible y sencillo de cerrar sesión (fallback si el dropdown está oculto) -->
            <button id="logoutBtnVisible" class="text-gray-600 hover:underline" style="background:none;border:0;padding:6px 8px;margin-left:8px;cursor:pointer;">Cerrar Sesión</button>
            <div class="user-dropdown" id="userDropdown">
                <ul role="menu">
                    <li role="menuitem" id="logoutBtn">Cerrar Sesión</li>
                </ul>
            </div>
            <!-- Datos del coordinador server-rendered (fallback para JS) -->
            <div id="serverUsuarioCoordinador" style="display:none;"
                 th:if="${usuarioCoordinador != null}"
                 th:data-nombre="${usuarioCoordinador.nombre}"
                 th:data-apellido="${usuarioCoordinador.apellido}"
                 th:data-email="${usuarioCoordinador.correo}"
                 th:data-rol="${(usuarioCoordinador.roles != null and !#lists.isEmpty(usuarioCoordinador.roles)) ? usuarioCoordinador.roles.get(0).name : 'Coordinador'}"
                 th:data-ficha="${usuarioCoordinador.ficha != null ? usuarioCoordinador.ficha.numeroFicha : ''}">
            </div>
            <!-- Formulario de logout oculto (Spring Security CSRF) -->
            <form id="logoutForm" th:action="@{/logout}" action="/logout" method="post" style="display:none;">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <noscript>
                    <button type="submit">Cerrar sesión</button>
                </noscript>
            </form>
        </div>
    </div>
</nav>
<aside class="sidebar" id="sidebar">
    <h2 class="sidebar-title">Bienvenido</h2>
    <h2 class="sidebar-title">Coordinador</h2>
    <div class="hola"></div>

    <nav aria-label="Menú Principal de la Aplicación">
        <ul id="menu">
            <li class="active" data-section="inicio">
                <a href="/coordinador" class="menu-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                    Inicio
                </a>
            </li>
            <li data-section="asistencia-ambiente">
                <a href="/coordinador/asistencia-ambiente" class="menu-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check-square"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>
                    Asistencia Ambiente
                </a>
            </li>
            <li data-section="asistencia-sede">
                <a href="/coordinador/asistencia-sede" class="menu-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-briefcase"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
                    Asistencia Sede
                </a>
            </li>
            <!-- Generar Reporte eliminado -->
            <li data-section="crear-novedad">
                <a href="/coordinador/crear-novedad" class="menu-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    Crear Novedad
                </a>
            </li>

            <li data-section="justificaciones">
                <a href="/coordinador/justificaciones" class="menu-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>
                    Justificaciones
                </a>
            </li>
            <li data-section="perfil">
                <a href="/coordinador/perfil" class="menu-link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    Mi Perfil
                </a>
            </li>
        </ul>
    </nav>
</aside>
<main class="main-content-wrapper">
    <!-- Resumen rápido del perfil eliminado: el contenido de perfil se muestra únicamente
         dentro de la sección "Mi Perfil" para evitar duplicidades. -->

    <div th:replace="${content}"></div>
</main>
<!-- Modal de notificaciones movido fuera del header para evitar solapamientos con otras vistas -->
<div id="notifModal" class="hidden fixed w-80 max-h-[64vh] overflow-auto bg-white shadow-2xl rounded-lg" role="dialog" aria-label="Lista de notificaciones" style="display:none; z-index:99999;">
    <div id="notifArrow" class="notif-arrow hidden" aria-hidden="true" style="z-index:99999;"></div>
    <div class="px-3 py-2 border-b">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <strong class="sr-only">Notificaciones</strong>
                <span id="headerUnread" class="text-xs text-white bg-emerald-600 px-2 py-0.5 rounded-full hidden" aria-hidden="true">0</span>
            </div>
            <div class="flex items-center gap-2 text-sm">
                <a id="linkVerTodas" href="/coordinador/notifications" class="text-gray-600 hover:underline">Ver todas</a>
                <button id="btnMarcarTodas" class="text-emerald-600 hover:underline">Marcar todas</button>
                <button id="btnCerrarNotif" class="text-gray-500 px-2 rounded hover:bg-gray-100" aria-label="Cerrar notificaciones">✕</button>
            </div>
        </div>

        <div class="mt-3">
            <nav class="flex gap-3 text-sm" aria-label="Filtros de notificaciones">
                <button class="tab-btn tab-active px-2 py-1 rounded-md" data-tab="all">Todas</button>
                <button class="tab-btn px-2 py-1 rounded-md" data-tab="unread">No leídas <span id="tabUnreadCount" class="ml-1 text-xs text-white bg-red-600 px-2 py-0.5 rounded-full hidden">0</span></button>
                <button class="tab-btn px-2 py-1 rounded-md" data-tab="mentioned">Menciones</button>
                <button class="tab-btn px-2 py-1 rounded-md" data-tab="assigned">Asignadas</button>
            </nav>

            <div class="mt-3">
                <input id="notifSearch" type="search" placeholder="Buscar en notificaciones..." class="w-full px-3 py-2 border rounded-md text-sm" />
            </div>
        </div>
    </div>
    <div class="px-3 pb-3">
        <div id="tabContentAll" class="tab-content max-h-56 overflow-auto"></div>
        <div id="tabContentUnread" class="tab-content max-h-56 overflow-auto hidden"></div>
        <div id="tabContentMentioned" class="tab-content max-h-56 overflow-auto hidden"></div>
        <div id="tabContentAssigned" class="tab-content max-h-56 overflow-auto hidden"></div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script th:src="@{/js/novedad-modal.js(v=${T(java.time.Instant).now().toEpochMilli()})}" src="/js/novedad-modal.js"></script>
<script th:src="@{/js/logicaC.js(v=${T(java.time.Instant).now().toEpochMilli()})}" src="/js/logicaC.js"></script>
<script th:src="@{/js/sidebar.js(v=${T(java.time.Instant).now().toEpochMilli()})}" src="/js/sidebar.js" defer></script>
<!-- Notificaciones widget script (posicionamiento dinámico y clic fuera para cerrar) -->
<script>
    (function(){
        const BELL = document.getElementById('bell');
        const COUNT = document.getElementById('notifCount');
        const MODAL = document.getElementById('notifModal');
        // elemento principal ya no es una sola lista, usamos contenedores por pestaña
        const LIST = document.getElementById('notifList');
        const TAB_ALL = document.getElementById('tabContentAll');
        const TAB_UNREAD = document.getElementById('tabContentUnread');
        const TAB_MENTIONED = document.getElementById('tabContentMentioned');
        const TAB_ASSIGNED = document.getElementById('tabContentAssigned');
        const ARROW = document.getElementById('notifArrow');
        const BTN_CLOSE = document.getElementById('btnCerrarNotif');
        const BTN_MARK_ALL = document.getElementById('btnMarcarTodas');

        // Rutas backend
        const API_UNREAD_COUNT = '/api/notificaciones/unread-count';
        const API_LIST = '/api/notificaciones?limit=10';
        const API_MARK_READ = '/api/notificaciones/mark-read';
        const API_MARK_ALL = '/api/notificaciones/mark-all-read';

        function setCount(n) {
            if (!COUNT) return;
            if (!n || n<=0) { COUNT.classList.add('hidden'); }
            else { COUNT.classList.remove('hidden'); COUNT.textContent = n>99 ? '99+' : n; }
        }

        async function fetchUnreadCount(){
            try {
                const r = await fetch(API_UNREAD_COUNT, { cache:'no-store' });
                if (!r.ok) return;
                const j = await r.json();
                setCount(j.unreadCount || 0);
                const headerBadge = document.getElementById('headerUnread');
                if (headerBadge){ if (j.unreadCount && j.unreadCount>0){ headerBadge.classList.remove('hidden'); headerBadge.textContent = j.unreadCount>99? '99+' : String(j.unreadCount); } else { headerBadge.classList.add('hidden'); } }
            } catch(e){ console.warn('notif count error', e); }
        }

        // cache local de notificaciones consultadas
        let _notifCache = [];
        let _currentTab = 'all';
        let _currentQuery = '';

        async function fetchList(){
            if (LIST) {
                LIST.innerHTML = '<div class="text-center text-gray-500 p-4">Cargando...</div>';
            } else if (TAB_ALL) {
                TAB_ALL.innerHTML = '<div class="text-center text-gray-500 p-4">Cargando...</div>';
            }
            try {
                const r = await fetch(API_LIST, { cache:'no-store' });
                if (!r.ok) {
                    if (LIST) LIST.innerHTML = '<div class="text-center text-gray-500 p-4">Error al cargar.</div>';
                    else if (TAB_ALL) TAB_ALL.innerHTML = '<div class="text-center text-gray-500 p-4">Error al cargar.</div>';
                    return;
                }
                const arr = await r.json();
                _notifCache = arr || [];
                updateTabUnreadCount();
                applyFilters();
            } catch(e) {
                if (LIST) LIST.innerHTML = '<div class="text-center text-gray-500 p-4">Error al cargar.</div>';
                else if (TAB_ALL) TAB_ALL.innerHTML = '<div class="text-center text-gray-500 p-4">Error al cargar.</div>';
                console.warn(e);
            }
        }

        function updateTabUnreadCount(){
            const unread = (_notifCache || []).filter(n => !n.read).length;
            const tabBadge = document.getElementById('tabUnreadCount');
            if(tabBadge){ if(unread>0){ tabBadge.classList.remove('hidden'); tabBadge.textContent = unread>99?'99+':String(unread); } else { tabBadge.classList.add('hidden'); } }
        }

        function applyFilters(){
            let items = Array.isArray(_notifCache) ? _notifCache.slice() : [];
            // filtro por búsqueda (aplica a todos)
            if(_currentQuery && _currentQuery.trim().length>0){
                const q = _currentQuery.trim().toLowerCase();
                items = items.filter(n => ((n.titulo||'')+ ' ' + (n.mensaje||'') + ' ' + (n.link||'')).toLowerCase().includes(q));
            }
            // preparar subconjuntos por pestaña
            const all = items;
            const unread = items.filter(n => !n.read);
            const mentioned = items.filter(n => n.mentioned || n.isMentioned || (n.tags && n.tags.includes && n.tags.includes('mention')) || (n.type && n.type==='mention'));
            const assigned = items.filter(n => n.assignedToMe || n.assigned || n.assignedTo || (n.type && n.type==='assigned'));

            clearAllTabContents();
            renderInto(TAB_ALL, all);
            renderInto(TAB_UNREAD, unread);
            renderInto(TAB_MENTIONED, mentioned);
            renderInto(TAB_ASSIGNED, assigned);
            // mostrar el contenedor correspondiente
            setActiveTab(_currentTab || 'all');
        }

        function fmtDate(iso){ try{ const d=new Date(iso); return d.toLocaleString(); }catch(e){return iso;} }

        function createItemElement(n){
            const item = document.createElement('div');
            item.className = 'flex gap-3 items-start px-4 py-3 border-b' + (n.read ? '' : ' bg-emerald-50');
            item.innerHTML = `<div class="flex-1"><div class="font-semibold text-sm text-gray-800">${escapeHtml(n.titulo||'Notificación')}</div><div class="text-sm text-gray-700 mt-1">${escapeHtml(n.mensaje||'')}</div><div class="meta text-xs text-gray-500 mt-2">${fmtDate(n.createdAt)}</div></div><div class="flex flex-col items-end gap-2">${n.read?'':'<button class="btn-link btn-mark text-emerald-600 text-sm" data-id="'+n.id+'">Marcar leído</button>'}${n.link?'<a class="btn-link text-emerald-600 text-sm" href="'+n.link+'">Abrir</a>':''}</div>`;
            return item;
        }

        function clearAllTabContents(){
            [TAB_ALL, TAB_UNREAD, TAB_MENTIONED, TAB_ASSIGNED].forEach(t=>{ if(t) t.innerHTML=''; });
        }

        function renderInto(container, arr){
            if(!container) return;
            if (!arr || !arr.length){ container.innerHTML = '<div class="text-center text-gray-500 p-4">No tienes notificaciones.</div>'; return; }
            container.innerHTML = '';
            arr.forEach(n=> container.appendChild(createItemElement(n)) );
            container.querySelectorAll('.btn-mark').forEach(b=>{ b.addEventListener('click', async ()=>{
                const id = b.getAttribute('data-id');
                try {
                    const r = await fetch(API_MARK_READ, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id }) });
                    if(!r.ok) throw 0;
                    await fetchUnreadCount();
                    await fetchList();
                } catch(e){ alert('No se pudo marcar como leído'); }
            }); });
        }

        function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

        // Posiciona el modal justo debajo de la campana y dentro del viewport
        function positionModal(){
            if(!BELL || !MODAL) return;
            const rect = BELL.getBoundingClientRect();
            // colocar modal fijo respecto al viewport
            MODAL.style.position = 'fixed';
            const top = Math.round(rect.bottom + 8);
            // Si el modal está oculto, temporalmente mostrarlo fuera de pantalla para medir
            const wasHidden = MODAL.classList.contains('hidden');
            if (wasHidden){ MODAL.classList.remove('hidden'); MODAL.style.left = '-9999px'; MODAL.style.visibility = 'hidden'; }
            let left = Math.round(rect.left + rect.width/2 - MODAL.offsetWidth/2);
            // mantener dentro del viewport
            left = Math.max(8, Math.min(left, window.innerWidth - MODAL.offsetWidth - 8));
            MODAL.style.top = top + 'px';
            MODAL.style.left = left + 'px';
            // posicionar flecha (si existe)
            if (ARROW){
                // asegurar que ARROW tiene tamaño
                const arrowW = ARROW.offsetWidth || 14;
                const centerX = rect.left + rect.width/2;
                let arrowLeft = Math.round(centerX - left - arrowW/2);
                arrowLeft = Math.max(8, Math.min(arrowLeft, MODAL.offsetWidth - arrowW - 8));
                ARROW.style.left = arrowLeft + 'px';
                ARROW.style.top = '-7px';
            }
            if (wasHidden){ MODAL.classList.add('hidden'); MODAL.style.visibility = ''; MODAL.style.left = ''; MODAL.style.display = 'none'; if (ARROW) ARROW.classList.add('hidden'); }
        }

        // Abre/cierra modal con posicionamiento dinámico
        function toggleModal(){
            const isHidden = MODAL.classList.contains('hidden');
            if(isHidden){
                MODAL.classList.remove('hidden');
                MODAL.style.display = 'block';
                if (ARROW) ARROW.classList.remove('hidden');
                positionModal();
                fetchUnreadCount();
                fetchList();
                BELL.setAttribute('aria-expanded', 'true');
            } else {
                MODAL.classList.add('hidden');
                MODAL.style.display = 'none';
                if (ARROW) ARROW.classList.add('hidden');
                BELL.setAttribute('aria-expanded', 'false');
            }
        }

        // Cerrar al clic fuera
        function onDocClick(e){
            if (!MODAL || !BELL) return;
            const target = e.target;
            if (MODAL.classList.contains('hidden')) return;
            if (MODAL.contains(target) || BELL.contains(target)) return;
            MODAL.classList.add('hidden');
            BELL.setAttribute('aria-expanded', 'false');
        }

        // event listeners
        BELL.addEventListener('click', (ev)=>{ ev.stopPropagation(); toggleModal(); });
        BTN_CLOSE.addEventListener('click', ()=> {
            MODAL.classList.add('hidden');
            MODAL.style.display = 'none';
            if (ARROW) ARROW.classList.add('hidden');
            BELL.setAttribute('aria-expanded','false');
        });
        BTN_MARK_ALL.addEventListener('click', async ()=>{
            if(!confirm('Marcar todas las notificaciones como leídas?')) return;
            try{
                const r = await fetch(API_MARK_ALL, { method:'POST' });
                if(!r.ok) throw 0;
                await fetchUnreadCount();
                await fetchList();
            }catch(e){ alert('No se pudo marcar todas como leídas'); }
        });

        // cerrar al hacer clic fuera
        document.addEventListener('click', onDocClick);
        // cerrar con ESC
        document.addEventListener('keydown', (ev)=>{ if(ev.key === 'Escape'){ if(!MODAL.classList.contains('hidden')){ MODAL.classList.add('hidden'); BELL.setAttribute('aria-expanded','false'); } } });
        window.addEventListener('resize', ()=>{ if(!MODAL.classList.contains('hidden')) positionModal(); });

        // al hacer clic en 'Ver todas' cerramos modal para navegación
        const linkVerTodas = document.getElementById('linkVerTodas');
        if(linkVerTodas){ linkVerTodas.addEventListener('click', ()=>{ MODAL.classList.add('hidden'); BELL.setAttribute('aria-expanded','false'); }); }

        // Pestañas y búsqueda
        const TAB_BUTTONS = Array.from(document.querySelectorAll('.tab-btn'));
        const SEARCH_INPUT = document.getElementById('notifSearch');
        function setActiveTab(tab){
            _currentTab = tab;
            TAB_BUTTONS.forEach(b=>{
                const target = b.dataset.tab;
                if(target===tab){ b.classList.add('tab-active'); b.classList.remove('text-gray-600'); }
                else { b.classList.remove('tab-active'); }
            });
            // ocultar/mostrar contenedores
            [TAB_ALL, TAB_UNREAD, TAB_MENTIONED, TAB_ASSIGNED].forEach(c=>{ if(!c) return; c.classList.add('hidden'); });
            if(tab==='all' && TAB_ALL) TAB_ALL.classList.remove('hidden');
            if(tab==='unread' && TAB_UNREAD) TAB_UNREAD.classList.remove('hidden');
            if(tab==='mentioned' && TAB_MENTIONED) TAB_MENTIONED.classList.remove('hidden');
            if(tab==='assigned' && TAB_ASSIGNED) TAB_ASSIGNED.classList.remove('hidden');
        }
        TAB_BUTTONS.forEach(b=>{ b.addEventListener('click', ()=> setActiveTab(b.dataset.tab)); });
        // búsqueda con debounce
        let _searchTimer = null;
        if(SEARCH_INPUT){ SEARCH_INPUT.addEventListener('input', (e)=>{ clearTimeout(_searchTimer); _searchTimer = setTimeout(()=>{ _currentQuery = e.target.value || ''; applyFilters(); }, 250); }); }

        // inicializar pestaña por defecto
        setActiveTab('all');

        // No hacer fetch automático al cargar: actualizamos cuando el usuario abre el modal.
    })();
</script>
<!-- Script removed: no route-specific hiding to keep coordinator menu consistent across views -->
<!-- Script temporal: remover decoraciones grandes (p. ej. lupa enorme) que interfieren con la UI -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Ejecutar con pequeño retardo para permitir que CSS/JS inyecten elementos
        setTimeout(() => {
            try {
                const candidates = Array.from(document.querySelectorAll('svg, img, .page-magnifier, .decorative-magnifier, .big-magnifier, .magnifier-overlay'));
                candidates.forEach(el => {
                    const r = el.getBoundingClientRect();
                    // Eliminar sólo elementos grandes y posicionados (probablemente decorativos)
                    if ((r.width >= 150 || r.height >= 150) && getComputedStyle(el).position !== 'static') {
                        el.remove();
                    }
                });
            } catch (e) { console.warn('Remove-decor-large error', e); }
        }, 120);
    });
</script>
<!-- Script mínimo para enviar el formulario de logout al hacer click en el elemento de menú -->
<script>
    (function(){
        function initLogout(){
            var btn = document.getElementById('logoutBtn');
            var form = document.getElementById('logoutForm');
            if(!btn || !form) return;
            btn.addEventListener('click', function(e){
                e.preventDefault();
                // confirmación ligera (opcional)
                if(window.confirm && !window.confirm('¿Cerrar sesión?')) return;
                form.submit();
            });
            // soportar botón visible alternativo
            var btnAlt = document.getElementById('logoutBtnVisible');
            if(btnAlt && btnAlt !== btn){
                btnAlt.addEventListener('click', function(e){ e.preventDefault(); if(window.confirm && !window.confirm('¿Cerrar sesión?')) return; form.submit(); });
            }
        }
        if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initLogout);
        else initLogout();
    })();
</script>
</body>
</html>
