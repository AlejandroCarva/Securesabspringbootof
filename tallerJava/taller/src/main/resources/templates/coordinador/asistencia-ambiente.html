<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<body th:replace="~{layouts/indexC :: layout(~{::content})}">
<div th:fragment="content">
    <section id="asistencia-ambiente-section" class="content-section" aria-labelledby="asistencia-ambiente-heading">
        <h2 id="asistencia-ambiente-heading">Asistencia en Ambiente</h2>
        <div class="filters">
            <div class="form-group">
                <label for="asistenciaAmbienteFicha">Filtrar por Ficha:</label>
                <select id="asistenciaAmbienteFicha" name="ficha">
                    <option value="all">Todas las Fichas</option>
                    <option th:each="f : ${listaFichas}" th:value="${f.numeroFicha}" th:text="${f.numeroFicha}"></option>
                </select>
            </div>
            <div class="form-group">
                <label for="asistenciaAmbienteDocumento">Filtrar por Documento/Nombre:</label>
                <input type="text" id="asistenciaAmbienteDocumento" name="documento" placeholder="Buscar por documento o nombre">
            </div>
            <div class="form-group">
                <label for="asistenciaAmbienteEstado">Estado:</label>
                <select id="asistenciaAmbienteEstado" name="estado">
                    <option value="all">Todos</option>
                    <!-- Valores observados en la base/tablas: incluir variantes históricas -->
                    <option value="Asistio">Asistio</option>
                    <option value="Inasistio">Inasistio</option>
                    <option value="Presente">Presente</option>
                    <option value="Ausente">Ausente</option>
                </select>
            </div>
            <div class="form-group date-range-group">
                <label for="asistenciaAmbienteFechaInicio">Fecha Inicio:</label>
                <input type="date" id="asistenciaAmbienteFechaInicio" name="fechaInicio">
            </div>
            <div class="form-group date-range-group">
                <label for="asistenciaAmbienteFechaFin">Fecha Fin:</label>
                <input type="date" id="asistenciaAmbienteFechaFin" name="fechaFin">
            </div>
        </div>
        <div class="table-responsive">
            <div class="table-actions">
                <button id="applyAmbienteFiltersBtn" class="btn secondary-btn" type="button" style="margin-right:8px;">Aplicar filtros</button>
                <button id="exportAmbienteBtn" class="btn primary-btn" type="button">Exportar CSV</button>
            </div>
            <table class="data-table">
                <thead>
                <tr>
                    <th>Documento</th>
                    <th>Nombre Aprendiz</th>
                    <th>Ficha</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                </tr>
                </thead>
                <tbody id="asistenciaAmbienteTabla" data-server="true">
                <tr th:each="a : ${asistenciasAmbiente}">
                    <td th:text="${a.usuario != null ? a.usuario.cedula : 'N/D'}"></td>
                    <td th:text="${a.usuario != null ? (a.usuario.nombre + ' ' + a.usuario.apellido) : 'N/D'}"></td>
                    <td th:text="${a.usuario != null && a.usuario.ficha != null ? a.usuario.ficha.numeroFicha : 'N/D'}"></td>
                    <td th:text="${a.fecha}"></td>
                    <td th:text="${a.estado}"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>
    <script>
        (function(){
            // Selectores
            const tbody = document.getElementById('asistenciaAmbienteTabla');
            const btnApply = document.getElementById('applyAmbienteFiltersBtn');
            const btnExport = document.getElementById('exportAmbienteBtn');
            const selFicha = document.getElementById('asistenciaAmbienteFicha');
            const inpDoc = document.getElementById('asistenciaAmbienteDocumento');
            const selEstado = document.getElementById('asistenciaAmbienteEstado');
            const inpFechaInicio = document.getElementById('asistenciaAmbienteFechaInicio');
            const inpFechaFin = document.getElementById('asistenciaAmbienteFechaFin');

            if(!tbody) return;

            function parseDateYMD(s){ if(!s) return null; try{ return new Date(s + 'T00:00:00'); } catch(e){ return null; } }

            function rowMatchesFilters(row){
                const cells = row.querySelectorAll('td');
                if(!cells || cells.length < 5) return false;
                const doc = (cells[0].textContent || '').trim().toLowerCase();
                const nombre = (cells[1].textContent || '').trim().toLowerCase();
                const ficha = (cells[2].textContent || '').trim();
                const fechaTxt = (cells[3].textContent || '').trim();
                const estado = (cells[4].textContent || '').trim();

                // Ficha
                if(selFicha && selFicha.value && selFicha.value !== 'all'){
                    if(ficha !== selFicha.value) return false;
                }
                // Documento/Nombre
                if(inpDoc && inpDoc.value && inpDoc.value.trim() !== ''){
                    const q = inpDoc.value.trim().toLowerCase();
                    if(!(doc.indexOf(q) !== -1 || nombre.indexOf(q) !== -1)) return false;
                }
                // Estado
                if(selEstado && selEstado.value && selEstado.value !== 'all'){
                    if(estado !== selEstado.value) return false;
                }
                // Fecha range
                const rowDate = parseDateYMD(fechaTxt);
                if(inpFechaInicio && inpFechaInicio.value){
                    const start = parseDateYMD(inpFechaInicio.value);
                    if(start && rowDate && rowDate < start) return false;
                }
                if(inpFechaFin && inpFechaFin.value){
                    const end = parseDateYMD(inpFechaFin.value);
                    if(end && rowDate && rowDate > end) return false;
                }
                return true;
            }

            function applyFilters(){
                const rows = Array.from(tbody.querySelectorAll('tr'));
                rows.forEach(r => {
                    if(rowMatchesFilters(r)) r.style.display = '';
                    else r.style.display = 'none';
                });
            }

            function exportVisibleToCSV(){
                const rows = Array.from(tbody.querySelectorAll('tr')).filter(r => r.style.display !== 'none');
                if(!rows.length){ alert('No hay filas para exportar.'); return; }
                const header = ['Documento','Nombre Aprendiz','Ficha','Fecha','Estado'];
                const csv = [header.join(',')];
                rows.forEach(r => {
                    const cols = Array.from(r.querySelectorAll('td')).map(td => '"' + (td.textContent||'').trim().replace(/"/g,'""') + '"');
                    csv.push(cols.join(','));
                });
                const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'asistencia-ambiente.csv';
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            }

            if(btnApply) btnApply.addEventListener('click', applyFilters);
            if(btnExport) btnExport.addEventListener('click', exportVisibleToCSV);

            // Aplicar filtros automáticamente si hay valores (útil tras navegación con parámetros)
            document.addEventListener('DOMContentLoaded', function(){ applyFilters(); });
        })();
    </script>
</div>
</body>
</html>